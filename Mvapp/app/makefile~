#Makefile for CSAPI 
#Copyright @ Celestial 2007

include ../config.mk
# Installed library (module)
#SLIBRARY	    	= lib$(MODULE_NAME).a
#DLIBRARY        	= lib$(MODULE_NAME).so  
SUBDIRS         	= src

# Test source and its related module
TESTDIR         	= test
TEST_DEPEND_MODULE	= 

# Sources & Objects
SOURCES			=  $(foreach SUBDIRS,$(SUBDIRS),$(wildcard $(SUBDIRS)/*.c))
HEADFILES       =  $(foreach SUBDIRS,$(SUBDIRS),$(wildcard $(SUBDIRS)/*.h))
OBJECTS			=  $(SOURCES:.c=.o)
MODULE_HEAD     =  $(wildcard ../include/$(MODULE_NAME).h)
DEMO_DEPEND_MODULE	= csevt csgpio cshdmi pthread mvipc csdemux csi2c csosd csvid csaud cstvout cssqc minigui ttf jpeg png z middleware csmid system_limit system_open system_sc system_merih rt teletext subtitle fwdebug ci mvmid security
# DEMO_DEPEND_MODULE	= csevt csgpio cshdmi pthread csdemux csi2c csosd csfrontpanel csvid csaud cstvout cssqc minigui jpeg png z middleware csmid system_limit system_open system_sc rt teletext subtitle fwdebug cssci ci mvmid
DEMORELATEDLIBS =  $(addprefix -l, $(DEMO_DEPEND_MODULE))

# defined flags
INCFLAGS    	+= -I ./include -I $(APP_WORK)/csapi/include -I $(APP_WORK)/mvapi/include -I ../csmid/include -I ../system/include -I ../middleware/include -I ../mvmid/include
DEFINES	    	+= -D_LINUX_
CFLAGS	    	+= -W -Wall  -O2
SHARED_FLAGS    += 
STATIC_FLAGS  	+= 

LIBS             = -L$(APP_WORK)/open_sources/libs -L$(APP_WORK)/csapi/lib -L$(APP_WORK)/mvapi/lib -L../middleware/lib  -L../system/lib -L../csmid/lib -L../mheg5/lib -L../mvmid/lib


.PRECIOUS: $(LIBRARY)
.SUFFIXES: .c .cc .cpp .cxx .yy.cpp .h

# define target and dependences

.c.o:
	@echo  CC   $< ...
	@$(CC) $(CFLAGS) -c  $(DEFINES) $(INCFLAGS) $< -o $@

.cc.o: 
	@echo  CC  $< ...
	@$(CXX) $(CFLAGS) -c $(DEFINES) $(INCFLAGS) $< -o $@

.cpp.o:
	@echo  CPP  $< ...
	@$(CXX) $(CFLAGS) -c $(DEFINES) $(INCFLAGS) $< -o $@

.cxx.o: 
	@echo  CXX  $< ...
	@$(CXX) $(CFLAGS) -c $(DEFINES) $(INCFLAGS) $< -o $@

# Make installation
all: mvapp

mvapp: $(OBJECTS)  
	@echo Link     $^ ...
	@$(CC)  $(CFLAGS) $(DEFINES) $(INCFLAGS) $(LIBS)  $^ -o $@.elf -Wl,--start-group $(DEMORELATEDLIBS) -Wl,--end-group
	@$(STRIP) $@.elf
	$(PWD)/ftpupl.sh
	#$(PWD)/kill-load-start.sh
	#cp mvapp.elf /NFS/

$(OBJECTS):  $(HEADFILES) $(MODULE_HEAD)

$(TESTOBJECTS):$(SLIBRARY) $(DLIBRARY) $(HEADFILES) $(MODULE_HEAD) $(TESTRELATEDHEAD) 
 
clean: 
	@$(RM) -f *.elf *.o *.so *.a $(OBJECTS) 	
